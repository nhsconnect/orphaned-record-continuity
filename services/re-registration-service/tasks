#!/usr/bin/env bash

set -Eeo pipefail

###########################
# Local Config Parameters #
###########################

AWS_DEFAULT_REGION=eu-west-2
export NHS_SERVICE=re-registration-service
IMAGE_REPO_NAME=repo/$NHS_SERVICE
AWS_HELPERS_VERSION=0.2.27
echo "AWS helper scripts version: $AWS_HELPERS_VERSION"

###########################
# Shared utils            #
###########################

function download_util() {
  local UTIL_VERSION=$1
  local UTIL_FILENAME=$2

  local UTIL_FILEPATH="utils/$UTIL_VERSION/$UTIL_FILENAME"

  mkdir -p "utils/$UTIL_VERSION"
  if [[ ! -f $UTIL_FILEPATH ]];then
    wget --quiet -O $UTIL_FILEPATH https://github.com/nhsconnect/prm-deductions-support-infra/releases/download/${UTIL_VERSION}/${UTIL_FILENAME}
  fi
  chmod +x $UTIL_FILEPATH

  echo "$UTIL_FILEPATH"
}

function fetch_redaction_utils() {
  download_util $AWS_HELPERS_VERSION run-with-redaction.sh
  download_util $AWS_HELPERS_VERSION redactor
}

AWS_HELPERS_FILE=$(download_util $AWS_HELPERS_VERSION aws-helpers)
source $AWS_HELPERS_FILE


####################################
# Instance (Environment) Variables #
####################################

function check_env {
  if [[ -z "${NHS_ENVIRONMENT}" ]]; then
    echo "Must set NHS_ENVIRONMENT"
    exit 1
  fi
}

function set_image_tag() {
  if [[ -z "${GO_DEPENDENCY_LABEL_APP}" ]]; then
    export IMAGE_TAG=${GO_PIPELINE_LABEL:-$(git rev-parse HEAD | cut -c 1-8)}
  else
    export IMAGE_TAG=${GO_DEPENDENCY_LABEL_APP}
  fi
}

function get_aws_account_id {
    AWS_ACCOUNT_ID=$(aws sts get-caller-identity | jq -r .Account)
}

function configure_envs {
  export LOCALSTACK_URL="http://localhost:4566"
  export AWS_REGION="eu-west-2"
  export AWS_DEFAULT_REGION="eu-west-2"
  export S3_BUCKET_NAME="test-bucket"
  export DYNAMODB_NAME="local-test-db"
  export DYNAMODB_LOCAL_ENDPOINT="http://localhost:4566"
  export AWS_ACCESS_KEY_ID="LSIA5678901234567890"
  export AWS_SECRET_ACCESS_KEY="LSIA5678901234567890"
  export NHS_ENVIRONMENT="local"
}

function configure_sonar_environment_variable {
  export SONAR_TOKEN=$(_get_aws_ssm_secret "/repo/dev/output/re-registration-service/sonar_token")
}

function use_fake_aws_creds_for_localstack {
  export AWS_ACCESS_KEY_ID=fake-key-id
  export AWS_SECRET_ACCESS_KEY=fake-key
}

function destroy_localstack {
  echo docker processes running: $(docker ps)

  DOCKER_CONTAINERS_ON_PORT=$(docker ps --filter publish=4566 -q)

  echo docker processes running on expected localstack port: $DOCKER_CONTAINERS_ON_PORT

  if [ -z "$DOCKER_CONTAINERS_ON_PORT" ]; then
    echo no localstack nonsense going on, cool
  else
    echo trying to kill localstack...
    docker stop $DOCKER_CONTAINERS_ON_PORT
  fi
}


###########
## TASKS ##
###########

command="$1"
case "${command}" in
  fetch_utils)
      fetch_redaction_utils
      ;;
  destroy_localstack)
      destroy_localstack
      ;;
  build_docker)
      configure_envs
      ./tasks _build
      configure_docker_repository_uri
      fetch_redaction_utils
      build_docker_image
      echo "Pushing the Docker image... $REPOSITORY_URI:$IMAGE_TAG"
      docker push $REPOSITORY_URI:$IMAGE_TAG
      ;;
  _build)
      rm -rf build/
      ./gradlew assemble
      ;;
  build)
      ./tasks _build
      ;;
  _test_unit)
      ./gradlew test
      ;;
  test_unit)
      ./tasks _test_unit
      ;;
  _test_integration)
      ./gradlew --info integration
      ;;
  test_integration)
      configure_envs
      use_fake_aws_creds_for_localstack
      destroy_localstack
      ./tasks _test_integration
      ;;
  _test_coverage)
      ./gradlew jacocoTestCoverageVerification
      ;;
  test_coverage)
      configure_envs
      destroy_localstack
      ./tasks _test_coverage
      ;;
  _code_quality)
      ./gradlew check -x test -x integration
      ;;
  code_quality)
      destroy_localstack
      ./tasks _code_quality
      ;;
  _test_all)
      ./gradlew test integration jacocoTestCoverageVerification check
      ;;
  test_all)
      configure_envs
      use_fake_aws_creds_for_localstack
      destroy_localstack
      ./tasks _test_all
      ;;
  _run_sonar)
      ./gradlew build sonar --info
      ;;
  run_sonar)
      configure_envs
      _assume_environment_role $NHS_ENVIRONMENT
      configure_sonar_environment_variable
      use_fake_aws_creds_for_localstack
      destroy_localstack
      ./tasks _run_sonar
      ;;
  run_local)
      configure_envs
      ./gradlew bootRun
      ;;
  run_localstack_local)
      docker-compose -f docker-compose.localstack-local.yaml up -d
      ;;
  _tf)
      _assume_environment_role $NHS_ENVIRONMENT
      tf_init
      bash
      ;;
  tf)
      check_env
      ./tasks _tf
      ;;
  _tf_plan)
      _assume_environment_role $NHS_ENVIRONMENT
      tf_plan $2
      ;;
  tf_plan)
      check_env
      ./tasks _tf_plan $2
      ;;
  _tf_apply)
      _assume_environment_role $NHS_ENVIRONMENT
      tf_apply
      ;;
  tf_apply)
      check_env
      ./tasks _tf_apply
      ;;
  promote_docker_image)
      check_env
      set_image_tag
      promote_docker_image "$IMAGE_REPO_NAME:$IMAGE_TAG" "$NHS_ENVIRONMENT"
      ;;
  _wait_ecs)
      _assume_environment_role $NHS_ENVIRONMENT
      aws ecs wait services-stable \
        --region $AWS_DEFAULT_REGION \
        --cluster $NHS_ENVIRONMENT-${NHS_SERVICE}-ecs-cluster \
        --service $NHS_ENVIRONMENT-${NHS_SERVICE}
      ;;
  wait_ecs)
      check_env
      ./tasks _wait_ecs
      ;;
  *)
      echo "Invalid command: '${command}'"
      exit 1
      ;;
esac
set +e
