name: Base Java Services Build and Deploy

on:
  workflow_dispatch:
    inputs:
      environment:
        type: choice
        options:
          - dev
          - pre-prod
          - prod
        required: true
        default: dev
        description: Which environment to build and deploy to?
      service:
        type: choice
        options:
          - ehr-transfer-service
        required: true
        description: Which service to build and deploy
      is_deployment:
        type: boolean
        default: false
        description: Whether to deploy of not
        required: true

  workflow_call:
    inputs:
      environment:
        type: string
        default: dev
        required: true
      service:
        type: string
        required: true
      is_deployment:
        type: boolean
        default: false
        required: true

permissions:
  pull-requests: write
  id-token: write
  contents: read

jobs:
  run_tests:
    name: Run Tests
    runs-on: ubuntu-latest
    defaults:
      run:             
        working-directory: './services/${{ inputs.service }}'
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        
      - name: Set up JDK 21
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: gradle

      - name: Start LocalStack
        uses: LocalStack/setup-localstack@v0.2.4
        with:
          install-awslocal: 'true'

      - name: Grant execute permission for gradlew
        run: chmod +x ./gradlew

      - name: Run Unit Tests
        run: ./tasks test_unit
        env:
          S3_BUCKET_NAME: test-bucket
          LOCALSTACK_URL: http://localhost:4566
          DYNAMODB_NAME: local-test-db
          DYNAMODB_LOCAL_ENDPOINT: http://localhost:4566
          AWS_ACCESS_KEY_ID: LSIA5678901234567890
          AWS_SECRET_ACCESS_KEY: LSIA5678901234567890
          SERVICE_URL: http://localhost:3000
          NHS_ENVIRONMENT: local
          EHR_URL: http://localhost:3000
          AUTHORIZATION_KEYS: auth-key-1

    #   - name: Build Code
    #     run: ./gradlew build

    #   - name: Run Integration Tests
    #     run: ./tasks test_integration